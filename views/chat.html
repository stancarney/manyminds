<html>
<head>
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.4.0/bootstrap.min.css">
	<script>
		$(document).ready(function() {
			var socket;
			var typing = false;
			var connected = false;
			var usersList = null;
			
			usersList = parseInt($("#userslist").css("top").substring(0, $("#userslist").css("top").indexOf("px")))
			$(window).scroll(function () {
				var offset = usersList + $(document).scrollTop() + "px";
				$("#userslist").animate({top:offset}, 0); //not sure if something other than animate exists?
			});

			connect();

			//TODO:Stan has to be a better way to do this.
			$("#autoscroll").click(function() {
				var v = $(this).text();
				if (v == 'On') {
					v = 'Off';
				} else {
					v = 'On';
					autoScroll();
				}

				$(this).html(v);
			});

			$("#nickname").keyup(function(e) {
				if (e.keyCode == 13) socket.emit('set nickname', $('#nickname').val());
			});

			$("#textentry").keyup(function(e) {
				var textarea = $('textarea#textentry');
				if (e.keyCode == 13) {
					socket.emit('message', { value: textarea.val() });
					textarea.val('');
					autoScroll();
				} else {
					if (!typing) {
						typing = true;
						socket.emit('typing');
					}

					setTimeout(function() {
						typing = false;
					}, 2000);
				}
			});

			setInterval(function() {
				$("ul#users>li.typing").removeClass("typing");
			}, 5000);

			function connect() {
				socket = io.connect('http://localhost:8080');

				socket.emit('set nickname', '{{= user }}');
				socket.emit('refresh');

				socket.on('chat', function (data) {
					$('#content').append('<div class="message" id=' + data._id + '>' + '[' + new Date(data.timestamp).toLocaleTimeString() + '] <strong>' + data.nickname + ':</strong> ' + data.message + '</div>');
					if($("#autoscroll").text() == 'On') autoScroll();
				});

				socket.on('old', function (data) {
					$('#content').prepend('<div class="message" id=' + data._id + '>' + '[' + new Date(data.timestamp).toLocaleTimeString() + '] <strong>' + data.nickname + ':</strong> ' + data.message + '</div>');
				});

				socket.on('add user', function (data) {
					$('#users').append('<li id="user_' + data.id + '">' + data.nickname + '</li>');
				});

				socket.on('remove user', function (data) {
					$('#user_' + data.id).remove();
				});

				socket.on('typing', function (data) {
					$('#user_' + data.id).addClass('typing');
				});
			}

			function autoScroll() {
				$('#content').animate({scrollTop: $(document).height()}, 1);
			}

			$('#content').scroll(function() {
				if ($('#content').scrollTop() == 0) {
					socket.emit('scroll', $('div.message').first().attr('id'));
					$('#content').scrollTop(1);
				}
			});
		});

	</script>
	<style type="text/css">
		ul {
			list-style-image: url("/images/arrow.gif")
		}

		.typing {
			color: #C43C35;
		}
	</style>
</head>
<body>

<div id="userslist" class="span2" style="top:0px;position:absolute;">
	<h3>Users</h3>
	<ul id="users"></ul>
	<div class="span2">
		<h3>Settings</h3>

		<form class="form-stacked" onsubmit="return false;">
			<fieldset>
				<div class="clearfix">
					<label for="nickname">Nickname</label>

					<div class="input">
						<input type="text" id="nickname" name="nickname" value="{{= user }}" class="span2"/>
					</div>
				</div>
				<div class="clearfix">
					<label for="autoscroll">Auto Scroll</label>

					<div class="input">
						<button id="autoscroll" class="btn primary">On</button>
					</div>
				</div>
			</fieldset>
		</form>

	</div>
</div>
<div class="row">
	<div class="span2">&nbsp;</div>
	<div class="offset2" style="height:80%%;overflow:auto;" id="content"></div>
</div>
<div class="row" id="footer">
	<div class="offset2" style="width:80%;">
		<textarea id="textentry" class="xxlarge" style="width:100%;height:5em;" rows="3"></textarea>
	</div>
</div>
</body>
</html>
