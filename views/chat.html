<!DOCTYPE html>
<html lang="en">
<head>
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript"
	        src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.0.2/bootstrap.min.js"></script>
	<script type="text/javascript" src="//twitter.github.com/bootstrap/assets/js/bootstrap-tab.js"></script>
	<script type="text/javascript" src="//twitter.github.com/bootstrap/assets/js/bootstrap-dropdown.js"></script>
	<link rel="stylesheet" href="//twitter.github.com/bootstrap/assets/css/bootstrap.css">
	<script>
		$(document).ready(function() {
			var socket;
			var connected = false;
			
			var typing = {};
			var hold = {};
			var loading = {};

			connect();
			
			socket.emit('refresh', querystring()['c']);

			setInterval(function() {
				$("ul#users>li.typing").removeClass("typing");
			}, 5000);

			function connect() {
				socket = io.connect('http://localhost:8000');

				//TODO:Stan this needs to update the URL based on channels joined from another channel
				socket.on('join', function (channel) {
					
					//setup channel vars
					typing[channel] = false;
					hold[channel] = false;
					loading[channel] = false;
					
					//Clone dummy channel
					var newChannel = $('#channel').clone();
					newChannel.css('display', '');
					newChannel.attr('id', channel);
					$('#channels').append(newChannel);

					//setup tabs
					$('#tabs').append('<li><a id="'+ channel +'" class="tab" data-toggle="tab" data-target="#channels #' + channel + '">' + channel + '</a></li>');
					$('#tabs a:first').tab('show');
					
					socket.emit('set nickname', channel, '{{= user }}');
					autoScroll(channel);
					
					//add events
					$('#tabs #' + channel).on("click", function(e) {
						autoScroll(channel);
					});
					
					$('a[data-toggle="tab"]').on('shown', function (e) {
					    autoScroll($(e.target).attr('id'));
					});
					
					$(nicknameId(channel)).on("keyup", function(e) {
						if (e.keyCode == 13) socket.emit('set nickname', channel, $(nicknameId(channel)).val());
					});

					$(textentryId(channel)).on("keyup", function(e) {
						var textarea = $(textentryId(channel));
						if (e.keyCode == 13) {
							socket.emit('message', channel, textarea.val() );
							textarea.val('');
							autoScroll(channel);
						} else {
							if (!typing[channel]) {
								typing[channel] = true;
								socket.emit('typing', channel);
							}

							setTimeout(function() {
								typing[channel] = false;
							}, 2000);
						}
					});

					$(contentId(channel)).on("scroll", function() {
						if (!loading[channel]) {
							if ($(contentId(channel)).scrollTop() == 0) {
								socket.emit('scroll', channel, $(contentId(channel)).find('div.message').first().attr('id'));
							}

							if ($(contentId(channel)).scrollTop() + $(contentId(channel)).height() == $(contentId(channel))[0].scrollHeight) {
								hold[channel] = false;
								autoScroll(channel);
							} else {
								hold[channel] = true;
							}
						}
					});
				});

				socket.on('new', function (message) {
					$(contentId(message.channel)).append('<div class="message" id=' + message._id + '>' + '[' + new Date(message.timestamp).toLocaleTimeString() + '] <strong>' + message.nickname + ':</strong> ' + message.value + '</div>');
					if (!hold[message.channel]) autoScroll(message.channel);
				});

				socket.on('old', function (message) {
					loading[message.channel] = true;
					$(contentId(message.channel)).prepend('<div class="message" id=' + message._id + '>' + '[' + new Date(message.timestamp).toLocaleTimeString() + '] <strong>' + message.nickname + ':</strong> ' + message.value + '</div>');
					$(contentId(message.channel)).scrollTop(1);
				});

				//stop scrolling when the server says it is complete
				socket.on('complete', function (channel) {
					loading[channel] = false;
				});

				socket.on('day', function (channel, timestamp) {
					$(contentId(channel)).prepend('<div class="day"><span class="day">' + new Date(timestamp).toLocaleDateString() + '</span></div>');
				});

				socket.on('add user', function (channel, nickname, id) {
					$(usersId(channel)).append('<li style="list-style-type:none" id="user_' + id + '"><i class="icon-user"></i> ' + nickname + '</li>');
				});

				socket.on('remove user', function (channel, id) {
					$(userId(channel, id)).remove();
				});

				socket.on('typing', function (channel, id) {
					$(userId(channel, id)).addClass('typing');
				});
			}

			function autoScroll(channel) {
				var element = $(contentId(channel));
				element.animate({scrollTop: element[0].scrollHeight}, 0);
			}

			function userId(channel, id) {
				return '#' + channel + ' #user_' + id;
			}
			
			function usersId(channel) {
				return '#' + channel + ' #users';
			}
			
			function contentId(channel) {
				return '#' + channel + ' #content';
			}

			function textentryId(channel) {
				return '#' + channel + ' #textentry';
			}

			function nicknameId(channel) {
				return '#' + channel + ' #nickname';
			}
			
			function querystring() {
				var nvpair = {};
				var pairs = window.location.search.replace('?', '').split('&');
				$.each(pairs, function(i, v) {
					var pair = v.split('=');
					if(!nvpair[pair[0]]) nvpair[pair[0]] = new Array();
					nvpair[pair[0]].push(pair[1]);
				});
				return nvpair;	
			}
		});

	</script>
	<style type="text/css">
		.header {
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
			height: 36px;
		}
		
		.content {
			position: absolute;
			left: 0;
			top: 36px;
			bottom: 0px;
			width: 100%;
		}
		
		.tab-content {
			display: inline;
		}

		.typing {
			color: #C43C35;
		}

		div.day {
			height: 1px;
			border-top: 1px solid #C43C35;
			text-align: center;
			position: relative;
			color: #C43C35;
		}

		span.day {
			position: relative;
			top: -.7em;
			background: white;
			display: inline-block;
		}
	</style>
</head>
<body>
	<div class="header">
		<ul id="tabs" class="nav nav-tabs"></ul>
	</div>
	<div class="content">
		<div class="tab-content">
			<div id="channels" class="tab-content"></div>
		</div>
	</div>
	<div id="channel" class="tab-pane" style="display:none;height:100%;">
		<div class="span2" style="width:140px;">
			<div class="well">
				<h3>Users</h3>
				<ul id="users"></ul>
				<h3>Settings</h3>

				<form class="form-stacked" onsubmit="return false;">
					<fieldset>
						<label for="nickname">Nickname</label>
						<input class="input-small" type="text" id="nickname" name="nickname" value="{{= user }}"/>
					</fieldset>
				</form>
			</div>
		</div>
		<div class="offset2" style="height:100%;">
			<div id="content" style="height:90%;overflow:scroll;overflow-x:auto;border-style:solid;border-width:1px;"></div>
			<div style="height:10%;">
				 <textarea id="textentry" style="height:100%;width:100%;padding: 0px;"></textarea>
			</div>
		</div>
	</div>
</body>
</html>
